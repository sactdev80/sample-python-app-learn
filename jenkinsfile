
pipeline {
    agent any

    environment {
        IMAGE_NAME = "flask-demo"
        CONTAINER_NAME = "flask-demo-container"
        PORT = "5000"
        BRANCH = "main"  // ✅ Change this to your target branch (e.g. master, dev)
    }

    triggers {
        // ✅ Auto-trigger Jenkins build when a GitHub webhook is received
        githubPush()
    }

    stages {
        stage('Clone Repository') {
            steps {
                script {
                    echo "Cloning branch: ${BRANCH}"
                }
                git branch: "${BRANCH}", url: 'https://github.com/sactdev80/sample-python-app-learn.git'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                echo "Building Docker image..."
                sudo docker build -t $IMAGE_NAME:latest .
                '''
            }
        }

        stage('Stop Old Container') {
            steps {
                sh '''
                echo "Stopping old container (if running)..."
                sudo docker ps -q --filter "name=$CONTAINER_NAME" | grep -q . && sudo docker stop $CONTAINER_NAME || true
                sudo docker ps -aq --filter "name=$CONTAINER_NAME" | grep -q . && sudo docker rm $CONTAINER_NAME || true
                '''
            }
        }

        stage('Run New Container') {
            steps {
                sh '''
                echo "Starting new container..."
                sudo docker run -d --name $CONTAINER_NAME -p $PORT:5000 $IMAGE_NAME:latest
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                echo "Waiting for Flask app to start..."
                sleep 5
                curl -f http://localhost:$PORT || echo "Flask app might not be reachable yet"
                sudo docker ps
                '''
            }
        }
    }
}
